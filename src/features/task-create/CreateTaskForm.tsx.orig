import React, { useState } from "react";
import { useCreateTask } from "@entities/task";
import { TaskPriority } from "@entities/task/model/types";
import styles from "./CreateTaskForm.module.scss";

interface CreateTaskFormProps {
  onSuccess?: () => void;
  onCancel: () => void;
}

export const CreateTaskForm: React.FC<CreateTaskFormProps> = ({
  onSuccess,
  onCancel,
}) => {
  const [title, setTitle] = useState("");
  const [description, setDescription] = useState("");
  const [completed, setCompleted] = useState(false);
  const [priority, setPriority] = useState<TaskPriority>("medium");
  
  const createTaskMutation = useCreateTask();

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!title.trim()) {
      alert("–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–¥–∞—á–∏");
      return;
    }

    createTaskMutation.mutate(
      {
        title: title.trim(),
        description: description.trim(),
        completed,
        priority,
      },
      {
        onSuccess: () => {
          setTitle("");
          setDescription("");
          setCompleted(false);
          setPriority("medium");
          if (onSuccess) onSuccess();
        },
      }
    );
  };

  const isSubmitting = createTaskMutation.isPending;

  const priorityOptions: { value: TaskPriority; label: string; color: string }[] = [
    { value: "low", label: "–ù–∏–∑–∫–∏–π", color: "#3b82f6", emoji: "üîµ" },
    { value: "medium", label: "–°—Ä–µ–¥–Ω–∏–π", color: "#f59e0b", emoji: "üü°" },
    { value: "high", label: "–í—ã—Å–æ–∫–∏–π", color: "#ef4444", emoji: "üî¥" },
    { value: "critical", label: "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π", color: "#dc2626", emoji: "‚ö†Ô∏è" },
  ];

  return (
    <form onSubmit={handleSubmit} className={styles.form}>
      <div className={styles.formGroup}>
        <label htmlFor="title" className={styles.label}>
          –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–¥–∞—á–∏ *
        </label>
        <input
          id="title"
          type="text"
          value={title}
          onChange={(e) => setTitle(e.target.value)}
          className={styles.input}
          placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é"
          disabled={isSubmitting}
          maxLength={100}
        />
        <div className={styles.counter}>
          {title.length}/100 —Å–∏–º–≤–æ–ª–æ–≤
        </div>
      </div>

      <div className={styles.formGroup}>
        <label htmlFor="description" className={styles.label}>
          –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
        </label>
        <textarea
          id="description"
          value={description}
          onChange={(e) => setDescription(e.target.value)}
          className={styles.textarea}
          placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≥–æ, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å..."
          disabled={isSubmitting}
          rows={5}
          maxLength={500}
        />
        <div className={styles.counter}>
          {description.length}/500 —Å–∏–º–≤–æ–ª–æ–≤
        </div>
      </div>

      <div className={styles.formGroup}>
        <label className={styles.label}>
          –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∑–∞–¥–∞—á–∏
        </label>
        <div className={styles.priorityOptions}>
          {priorityOptions.map((option) => {
            const bgColor = priority === option.value ? 
              `${option.color}15` : "#f9fafb";
            
            return (
              <label
                key={option.value}
                className={styles.priorityOption}
                style={{
                  borderColor: priority === option.value ? option.color : "#d1d5db",
                  backgroundColor: bgColor,
                }}
              >
                <input
                  type="radio"
                  name="priority"
                  value={option.value}
                  checked={priority === option.value}
                  onChange={(e) => setPriority(e.target.value as TaskPriority)}
                  className={styles.priorityRadio}
                  disabled={isSubmitting}
                />
                <span className={styles.priorityLabel} style={{ color: option.color }}>
                  {option.emoji} {option.label}
                </span>
              </label>
            );
          })}
        </div>
      </div>

      <div className={styles.formGroup}>
        <div className={styles.checkboxGroup}>
          <input
            id="completed"
            type="checkbox"
            checked={completed}
            onChange={(e) => setCompleted(e.target.checked)}
            className={styles.checkbox}
            disabled={isSubmitting}
          />
          <label htmlFor="completed" className={styles.checkboxLabel}>
            –ó–∞–¥–∞—á–∞ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞
          </label>
        </div>
      </div>

      <div className={styles.formFooter}>
        <div className={styles.buttons}>
          <button
            type="button"
            onClick={onCancel}
            className={styles.cancelButton}
            disabled={isSubmitting}
          >
            –û—Ç–º–µ–Ω–∞
          </button>
          <button
            type="submit"
            className={styles.submitButton}
            disabled={isSubmitting || !title.trim()}
          >
            {isSubmitting ? (
              <>
                <span className={styles.spinner}></span>
                –°–æ–∑–¥–∞–Ω–∏–µ...
              </>
            ) : (
              "–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É"
            )}
          </button>
        </div>
        
        <div className={styles.hint}>
          * ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ
        </div>
      </div>
      
      {createTaskMutation.isError && (
        <div className={styles.error}>
          –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏: {createTaskMutation.error.message}
        </div>
      )}
    </form>
  );
};
