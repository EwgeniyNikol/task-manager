import React, { useState, useEffect } from "react";
import { Task, TaskPriority } from "@entities/task/model/types";
import { useUpdateTask } from "@entities/task";
import { Modal } from "@shared/ui/modal";
import styles from "./TaskEditForm.module.scss";

interface TaskEditFormProps {
  task: Task;
}

export const TaskEditForm: React.FC<TaskEditFormProps> = ({ task }) => {
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [title, setTitle] = useState(task.title);
  const [description, setDescription] = useState(task.description);
  const [completed, setCompleted] = useState(task.completed);
  const [priority, setPriority] = useState<TaskPriority>(task.priority || "medium");
  
  const updateTaskMutation = useUpdateTask();

  useEffect(() => {
    if (isModalOpen) {
      setTitle(task.title);
      setDescription(task.description);
      setCompleted(task.completed);
      setPriority(task.priority || "medium");
    }
  }, [isModalOpen, task]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!title.trim()) {
      alert("–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–¥–∞—á–∏");
      return;
    }

    updateTaskMutation.mutate(
      {
        id: task.id,
        title: title.trim(),
        description: description.trim(),
        completed,
        priority,
      },
      {
        onSuccess: () => {
          setIsModalOpen(false);
        },
      }
    );
  };

  const isSubmitting = updateTaskMutation.isPending;

  const priorityOptions: { value: TaskPriority; label: string; color: string; emoji: string }[] = [
    { value: "low", label: "–ù–∏–∑–∫–∏–π", color: "#3b82f6", emoji: "üîµ" },
    { value: "medium", label: "–°—Ä–µ–¥–Ω–∏–π", color: "#f59e0b", emoji: "üü°" },
    { value: "high", label: "–í—ã—Å–æ–∫–∏–π", color: "#ef4444", emoji: "üî¥" },
    { value: "critical", label: "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π", color: "#dc2626", emoji: "‚ö†Ô∏è" },
  ];

  return (
    <>
      <button
        onClick={() => setIsModalOpen(true)}
        className={styles.editButton}
      >
        ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
      </button>

      <Modal
        isOpen={isModalOpen}
        onClose={() => !isSubmitting && setIsModalOpen(false)}
        title={`–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ #${task.id}`}
        width="600px"
      >
        <form onSubmit={handleSubmit} className={styles.form}>
          <div className={styles.formGroup}>
            <label htmlFor={`title-${task.id}`} className={styles.label}>
              –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–¥–∞—á–∏ *
            </label>
            <input
              id={`title-${task.id}`}
              type="text"
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              className={styles.input}
              placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–¥–∞—á–∏"
              disabled={isSubmitting}
              maxLength={100}
            />
            <div className={styles.counter}>
              {title.length}/100 —Å–∏–º–≤–æ–ª–æ–≤
            </div>
          </div>

          <div className={styles.formGroup}>
            <label htmlFor={`description-${task.id}`} className={styles.label}>
              –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
            </label>
            <textarea
              id={`description-${task.id}`}
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              className={styles.textarea}
              placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏..."
              disabled={isSubmitting}
              rows={6}
              maxLength={1000}
            />
            <div className={styles.counter}>
              {description.length}/1000 —Å–∏–º–≤–æ–ª–æ–≤
            </div>
          </div>

          <div className={styles.formGroup}>
            <label className={styles.label}>
              –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∑–∞–¥–∞—á–∏
            </label>
            <div className={styles.priorityOptions}>
              {priorityOptions.map((option) => {
                const bgColor = priority === option.value ? 
                  `${option.color}15` : "#f9fafb";
                
                return (
                  <label
                    key={option.value}
                    className={styles.priorityOption}
                    style={{
                      borderColor: priority === option.value ? option.color : "#d1d5db",
                      backgroundColor: bgColor,
                    }}
                  >
                    <input
                      type="radio"
                      name="priority"
                      value={option.value}
                      checked={priority === option.value}
                      onChange={(e) => setPriority(e.target.value as TaskPriority)}
                      className={styles.priorityRadio}
                      disabled={isSubmitting}
                    />
                    <span className={styles.priorityLabel} style={{ color: option.color }}>
                      {option.emoji} {option.label}
                    </span>
                  </label>
                );
              })}
            </div>
          </div>

          <div className={styles.formGroup}>
            <div className={styles.checkboxGroup}>
              <input
                id={`completed-${task.id}`}
                type="checkbox"
                checked={completed}
                onChange={(e) => setCompleted(e.target.checked)}
                className={styles.checkbox}
                disabled={isSubmitting}
              />
              <label htmlFor={`completed-${task.id}`} className={styles.checkboxLabel}>
                –ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞
              </label>
            </div>
          </div>

          <div className={styles.formFooter}>
            <div className={styles.buttons}>
              <button
                type="button"
                onClick={() => setIsModalOpen(false)}
                className={styles.cancelButton}
                disabled={isSubmitting}
              >
                –û—Ç–º–µ–Ω–∞
              </button>
              <button
                type="submit"
                className={styles.submitButton}
                disabled={isSubmitting || !title.trim()}
              >
                {isSubmitting ? (
                  <>
                    <span className={styles.spinner}></span>
                    –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...
                  </>
                ) : (
                  "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è"
                )}
              </button>
            </div>
            
            <div className={styles.hint}>
              * ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ
            </div>
          </div>
          
          {updateTaskMutation.isError && (
            <div className={styles.error}>
              –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: {updateTaskMutation.error.message}
            </div>
          )}
        </form>
      </Modal>
    </>
  );
};
